<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recharge</title>

  <style>
    :root {
      --primary: #0b274d;
      --accent: #0e4aa8;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(2, 8, 23, 0.25);
      --radius: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    body {
      background: #eef3fb;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* ---------------- BACKGROUND BLOBS ---------------- */
    body::before {
      content: "";
      position: fixed;
      top: -80px;
      right: -100px;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle,
          rgba(14, 74, 168, 0.28),
          transparent 70%);
      filter: blur(12px);
      z-index: -1;
    }

    body::after {
      content: "";
      position: fixed;
      bottom: -100px;
      left: -120px;
      width: 450px;
      height: 450px;
      background: radial-gradient(circle,
          rgba(11, 39, 77, 0.22),
          transparent 75%);
      filter: blur(18px);
      z-index: -1;
    }

    /* FLOATING DOTS */
    .decorate-dot {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(14, 74, 168, 0.5);
      animation: float 5s infinite alternate ease-in-out;
    }

    /* ---------------- NAVBAR ---------------- */
    header {
      width: 100%;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      padding: 12px 16px;
      color: white;
      display: flex;
      align-items: center;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .back-btn {
      background: transparent;
      border: 0;
      color: white;
      font-size: 20px;
      margin-right: 10px;
      cursor: pointer;
    }

    #walletBox {
      margin-left: auto;
      padding: 6px 14px;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 20px;
      font-size: 14px;
      backdrop-filter: blur(6px);
    }

    /* ---------------- HERO SECTION ---------------- */
    .hero {
      width: 94%;
      margin: 20px auto 10px;
      background: linear-gradient(120deg, #0b274d, #0e4aa8);
      padding: 26px;
      color: white;
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.22);
    }

    .hero::after {
      content: "";
      position: absolute;
      right: -40px;
      top: -40px;
      width: 220px;
      height: 220px;

      opacity: 0.25;
    }

    .hero h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    /* ---------------- MAIN UI ---------------- */
    .container {
      width: 94%;
      max-width: 900px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .tab-btn {
      padding: 10px 18px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    }

    .tab-btn.active {
      background: linear-gradient(90deg, var(--accent), var(--primary));
      color: white;
      border: 0;
    }

    .amount-box {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .amt-btn {
      padding: 12px 24px;
      background: white;
      border-radius: 40px;
      border: 1px solid #dde3f2;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: 0.2s;
    }

    .amt-btn.active {
      background: linear-gradient(90deg, var(--accent), var(--primary));
      color: white;
    }

    .card {
      background: white;
      padding: 18px;
      border-radius: 16px;
      margin-top: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
    }

    .input-box {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #dfe5f2;
      border-radius: 10px;
      padding: 10px;
    }

    .input-box input {
      width: 100%;
      border: 0;
      font-size: 16px;
      outline: none;
    }

    .pay-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      box-shadow: var(--shadow);
    }

    /* ---------------- QR MODAL ---------------- */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: 0.2s;
      z-index: 200;
    }

    .overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .modal {
      width: 420px;
      max-width: 92%;
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
      animation: pop 0.25s ease;
      max-height: 85vh;
      overflow-y: auto;
    }

    @keyframes pop {
      from {
        transform: scale(0.92);
        opacity: 0.4;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .qr-box {
      margin: 10px auto;
      padding: 14px;
      background: #f4f6ff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      position: relative;
    }

    .qr-box img {
      width: 220px;
      height: 220px;
      border-radius: 10px;
    }

    .qr-box::after {
      content: "";
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 30px;
      background: radial-gradient(circle, rgba(0, 0, 0, 0.18), transparent);
      filter: blur(10px);
    }

    #closeModal {
      position: absolute;
      top: 10px;
      right: 14px;
      background: none;
      border: 0;
      font-size: 24px;
      cursor: pointer;
    }

    .utr-input {
      margin-top: 18px;
      background: white;
      border: 1px solid #d4d8e2;
      padding: 10px;
      border-radius: 10px;
      width: 100%;
      font-size: 15px;
    }

    .submit-utr {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      border: 0;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      cursor: pointer;
    }

    /* SUCCESS TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      color: white;
      padding: 12px 18px;
      border-radius: 12px;
      opacity: 0;
      transform: translateY(10px);
      transition: 0.3s;
      z-index: 300;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <!-- Floating Dots -->
  <div class="decorate-dot" style="top: 140px; left: 80px"></div>
  <div class="decorate-dot" style="top: 260px; right: 140px"></div>
  <div class="decorate-dot" style="top: 420px; left: 320px"></div>

  <!-- Navbar -->
  <header>
    <button class="back-btn" onclick="window.location.href='home.html'">
      ←
    </button>
    Recharge
    <div id="walletBox">Wallet: ₹ <span id="walletAmount">0</span></div>
  </header>

  <!-- Hero Banner -->
  <div class="hero">
    <h1>Recharge Wallet</h1>
    <span>Fast • Secure • Instant UPI Payments</span>
  </div>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active">Recharge</button>
      <button class="tab-btn" onclick="window.location.href='withdraw.html'">
        Withdraw
      </button>
    </div>

    <h3 style="margin-top: 20px; font-size: 16px; color: #0b274d">
      Recharge Plans
    </h3>
    <div class="amount-box" id="rechargePlansBox"></div>


    <div class="card">
      <div style="font-weight: 700; margin-bottom: 6px">Amount</div>
      <div class="input-box">
        <span>₹</span>
        <input type="number" id="amountInput" placeholder="Enter amount" />
      </div>
    </div>

    <button class="pay-btn" id="payNowBtn">Pay 0</button>
  </div>

  <!-- Modal -->
  <div class="overlay" id="paymentOverlay">
    <div class="modal">
      <button id="closeModal">×</button>
      <h2 style="margin-bottom: 10px">Scan & Pay</h2>

      <div class="qr-box">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=upi://pay?pa=yourupi@okaxis&pn=RedbullOwner"
          alt="QR Code" />
      </div>

      <input class="utr-input" id="utrInput" placeholder="Enter UTR / Transaction ID" />

      <button class="submit-utr" id="submitUTR">Submit</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Payment Submitted Successfully</div>
  <script>
    const token = localStorage.getItem("authToken");

    if (!token) {
      window.location.href = "index.html";
    }

    let selectedPlan = null;

    async function loadPlansForRecharge() {
      const res = await fetch("http://localhost:4000/api/plans");
      const data = await res.json();
      const plans = data.plans || [];
      // SELECT RECHARGE PLANS (non-vip buy plans)
      return plans.filter((p) => p.type === "buy" && !p.isVip);
    }

    const API_URL = "http://localhost:4000/api/payment/request";

    /* ------------ WALLET DISPLAY ------------ */
    function loadWalletAmount() {
      const session = JSON.parse(localStorage.getItem("lp_session_v1") || "null");
      const walletSpan = document.getElementById("walletAmount");
      if (!session) return;
      const users = JSON.parse(localStorage.getItem("lp_users_v1") || "[]");
      const user = users.find((u) => u.phone === session.phone);
      walletSpan.textContent = user?.wallet ? user.wallet.toFixed(2) : "0";
    }
    loadWalletAmount();

    /* ------------ amount buttons ------------ */
    const amountInput = document.getElementById("amountInput");
    const payBtn = document.getElementById("payNowBtn");

    function updatePayBtn() {
      const val = Number(amountInput.value) || 0;
      payBtn.textContent = "Pay " + val;
    }

    amountInput.addEventListener("input", updatePayBtn);

    /* ------------ modal open ------------ */
    const overlay = document.getElementById("paymentOverlay");

    payBtn.addEventListener("click", () => {
      const val = Number(amountInput.value);
      if (!val || val <= 0) return alert("Please enter an amount first.");
      overlay.classList.add("show");
    });

    /* ------------ modal close ------------ */
    document.getElementById("closeModal").onclick = () =>
      overlay.classList.remove("show");
    overlay.onclick = (e) => {
      if (e.target === overlay) overlay.classList.remove("show");
    };

    /* ------------ Submit UTR (BACKEND CONNECTED) ------------ */
    document.getElementById("submitUTR").onclick = async () => {
      const utr = document.getElementById("utrInput").value.trim();
      const amount = Number(amountInput.value);

      if (!amount || amount <= 0) return alert("Please enter a valid amount");
      if (!utr) return alert("Please enter UTR / Transaction ID");

      overlay.classList.remove("show");

      const body = {
        amount,
        utr,
        planId: null // FORCE WALLET TOP-UP
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        if (!data.success) return alert(data.message);

        showToast("Payment Submitted Successfully");
        amountInput.value = "";
        document.getElementById("utrInput").value = "";
        updatePayBtn(); // Reset button text
      } catch (e) {
        console.error("Payment Error:", e);
        alert("Error: " + e.message);
      }
    };

    async function showRechargePlans() {
      const rechargePlans = await loadPlansForRecharge();
      const box = document.getElementById("rechargePlansBox");
      box.innerHTML = "";

      rechargePlans.forEach((p) => {
        const btn = document.createElement("button");
        btn.className = "amt-btn";
        btn.dataset.value = p.price;
        btn.textContent = `${p.name} - ₹${p.price}`;

        btn.onclick = () => {
          document.querySelectorAll(".amt-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          amountInput.value = p.price;
          updatePayBtn();
        };

        box.appendChild(btn);
      });
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      showRechargePlans();
    });

  </script>
</body>

</html>